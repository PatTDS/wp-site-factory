/**
 * <%= company.name %> E2E Tests
 *
 * Generated by WPF Site Factory
 */
import { test, expect } from '@playwright/test';

test.describe('<%= company.name %> Website E2E Tests', () => {
  test.beforeEach(async ({ page }) => {
    // Increase timeout for WordPress
    test.setTimeout(30000);
  });

  // ============================================
  // Homepage Tests
  // ============================================
  test('Homepage loads correctly', async ({ page }) => {
    await page.goto('/');

    // Check page title
    await expect(page).toHaveTitle(/<%= company.name %>/);

    // Check hero section exists
    await expect(page.locator('h1')).toBeVisible();

    // Check navigation exists
    await expect(page.locator('nav')).toBeVisible();

    // Check footer exists
    await expect(page.locator('footer')).toBeVisible();
  });

  test('Navigation menu is visible', async ({ page }) => {
    await page.goto('/');

    // Check menu items exist in nav
    <%_ menu.primary.forEach(function(item) { _%>
    await expect(page.locator('nav').getByRole('link', { name: '<%= item.title %>' })).toBeVisible();
    <%_ }); _%>
  });

  // ============================================
  // Page Tests
  // ============================================
  <%_ pages.forEach(function(p) { _%>
  <%_ if (p.slug !== 'home') { _%>
  test('<%= p.title %> page loads', async ({ page }) => {
    await page.goto('/<%= p.slug %>/');

    await expect(page).toHaveTitle(/<%= p.title %>/);
    await expect(page.locator('h1')).toContainText(/<%= p.title %>/i);
  });

  <%_ } _%>
  <%_ }); _%>

  // ============================================
  // Navigation Tests
  // ============================================
  test('Navigation links work', async ({ page }) => {
    await page.goto('/');

    <%_ menu.primary.forEach(function(item) { _%>
    <%_ if (item.url.startsWith('/') && item.url !== '/') { _%>
    // Navigate to <%= item.title %>
    await page.locator('nav').getByRole('link', { name: '<%= item.title %>', exact: true }).click();
    await expect(page).toHaveURL(/<%= item.url.replace(/\//g, '\\/') %>/);
    await page.goto('/');

    <%_ } _%>
    <%_ }); _%>
  });

  // ============================================
  // Responsive Tests
  // ============================================
  test('Site is responsive on mobile', async ({ page }) => {
    // Set mobile viewport
    await page.setViewportSize({ width: 375, height: 667 });
    await page.goto('/');

    // Check mobile menu button exists
    await expect(page.locator('#mobile-menu-toggle')).toBeVisible();

    // Check content is visible
    await expect(page.locator('h1')).toBeVisible();
  });

  test('Site is responsive on tablet', async ({ page }) => {
    // Set tablet viewport
    await page.setViewportSize({ width: 768, height: 1024 });
    await page.goto('/');

    // Content should be visible
    await expect(page.locator('h1')).toBeVisible();
    await expect(page.locator('footer')).toBeVisible();
  });

  // ============================================
  // Error Handling Tests
  // ============================================
  test('No console errors on homepage', async ({ page }) => {
    const errors: string[] = [];
    page.on('console', msg => {
      if (msg.type() === 'error') {
        errors.push(msg.text());
      }
    });

    await page.goto('/');
    await page.waitForLoadState('networkidle');

    // Filter out known acceptable errors
    const criticalErrors = errors.filter(e =>
      !e.includes('favicon') &&
      !e.includes('Third-party') &&
      !e.includes('404') &&
      !e.includes('Failed to load resource')
    );

    expect(criticalErrors).toHaveLength(0);
  });

  test('404 page works', async ({ page }) => {
    const response = await page.goto('/non-existent-page-12345/');
    expect(response?.status()).toBe(404);
  });

  // ============================================
  // Accessibility Tests
  // ============================================
  test('Images have alt text', async ({ page }) => {
    await page.goto('/');

    const images = await page.locator('img').all();
    for (const img of images) {
      const alt = await img.getAttribute('alt');
      expect(alt).not.toBeNull();
    }
  });

  test('Links are accessible', async ({ page }) => {
    await page.goto('/');

    const links = await page.locator('a').all();
    for (const link of links) {
      const href = await link.getAttribute('href');
      const text = await link.textContent();
      const ariaLabel = await link.getAttribute('aria-label');

      // Links should have either text content or aria-label
      expect(text?.trim() || ariaLabel).toBeTruthy();
    }
  });

  // ============================================
  // Form Tests
  // ============================================
  <%_ if (pages.some(p => p.template === 'contact')) { _%>
  test('Contact form is visible', async ({ page }) => {
    await page.goto('/contact/');

    // Check form elements
    await expect(page.locator('form')).toBeVisible();
  });
  <%_ } _%>
});
