#!/bin/bash
#
# <%= company.name %> - WordPress Setup Script
# Generated by WPF Site Factory
#
# This script automates the complete WordPress setup:
# - Install WordPress core
# - Activate theme and plugin
# - Install and configure plugins
# - Create pages and menus
# - Configure settings
#

set -e

# Configuration
CONTAINER="${CONTAINER:-<%= project.name %>_wp}"
WP_URL="${WP_URL:-http://localhost:8080}"
WP_TITLE="${WP_TITLE:-<%= company.name %>}"
WP_ADMIN_USER="${WP_ADMIN_USER:-admin}"
WP_ADMIN_PASSWORD="${WP_ADMIN_PASSWORD:-admin123}"
WP_ADMIN_EMAIL="${WP_ADMIN_EMAIL:-<%= contact.email %>}"
THEME_NAME="<%= project.name %>-theme"
PLUGIN_NAME="<%= project.name %>-plugin"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Logging functions
log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Wait for WordPress container to be ready
wait_for_wordpress() {
    log_info "Waiting for WordPress to be ready..."
    local max_attempts=30
    local attempt=1

    while [ $attempt -le $max_attempts ]; do
        if docker exec $CONTAINER wp core is-installed --allow-root 2>/dev/null; then
            return 0
        fi

        if docker exec $CONTAINER curl -s http://localhost/ | grep -q "WordPress"; then
            return 0
        fi

        log_info "Attempt $attempt/$max_attempts - WordPress not ready yet..."
        sleep 5
        ((attempt++))
    done

    return 1
}

# Install WordPress
install_wordpress() {
    log_info "Installing WordPress..."

    docker exec $CONTAINER wp core install \
        --url="$WP_URL" \
        --title="$WP_TITLE" \
        --admin_user="$WP_ADMIN_USER" \
        --admin_password="$WP_ADMIN_PASSWORD" \
        --admin_email="$WP_ADMIN_EMAIL" \
        --skip-email \
        --allow-root

    log_info "WordPress installed successfully"
}

# Activate theme
activate_theme() {
    log_info "Activating theme: $THEME_NAME"

    docker exec $CONTAINER wp theme activate "$THEME_NAME" --allow-root

    log_info "Theme activated"
}

# Activate plugin
activate_plugin() {
    log_info "Activating plugin: $PLUGIN_NAME"

    docker exec $CONTAINER wp plugin activate "$PLUGIN_NAME" --allow-root || true

    log_info "Plugin activated"
}

# Install and activate required plugins
install_plugins() {
    log_info "Installing plugins..."

    local plugins=(
        "wordpress-seo"
        "autoptimize"
        "shortpixel-image-optimiser"
        "contact-form-7"
    )

    for plugin in "${plugins[@]}"; do
        log_info "Installing $plugin..."
        docker exec $CONTAINER wp plugin install "$plugin" --activate --allow-root || {
            log_warn "Failed to install $plugin, continuing..."
        }
    done

    log_info "Plugins installed"
}

# Configure WordPress settings
configure_settings() {
    log_info "Configuring WordPress settings..."

    # Permalink structure
    docker exec $CONTAINER wp rewrite structure '/%postname%/' --allow-root

    # Timezone
    docker exec $CONTAINER wp option update timezone_string 'America/Sao_Paulo' --allow-root

    # Date format
    docker exec $CONTAINER wp option update date_format 'd/m/Y' --allow-root

    # Blog description
    docker exec $CONTAINER wp option update blogdescription '<%= company.tagline %>' --allow-root

    # Disable comments on pages
    docker exec $CONTAINER wp option update default_comment_status 'closed' --allow-root

    # Disable pingbacks
    docker exec $CONTAINER wp option update default_ping_status 'closed' --allow-root

    log_info "Settings configured"
}

# Create pages
create_pages() {
    log_info "Creating pages..."

    <%_ pages.forEach(function(page) { _%>
    # Create <%= page.title %> page
    docker exec $CONTAINER wp post create \
        --post_type=page \
        --post_title='<%= page.title %>' \
        --post_name='<%= page.slug %>' \
        --post_status=publish \
        --allow-root || log_warn "Page '<%= page.title %>' may already exist"

    <%_ }); _%>

    log_info "Pages created"
}

# Set homepage
set_homepage() {
    log_info "Setting homepage..."

    # Get front page ID
    local front_page_id=$(docker exec $CONTAINER wp post list \
        --post_type=page \
        --name='home' \
        --format=ids \
        --allow-root)

    if [ -n "$front_page_id" ]; then
        docker exec $CONTAINER wp option update show_on_front 'page' --allow-root
        docker exec $CONTAINER wp option update page_on_front "$front_page_id" --allow-root
        log_info "Homepage set"
    else
        log_warn "Could not find home page"
    fi
}

# Create primary menu
create_menu() {
    log_info "Creating navigation menu..."

    # Delete existing menu if it exists
    docker exec $CONTAINER wp menu delete "Primary Menu" --allow-root 2>/dev/null || true

    # Create menu
    docker exec $CONTAINER wp menu create "Primary Menu" --allow-root

    <%_ menu.primary.forEach(function(item, index) { _%>
    # Add <%= item.title %> to menu
    docker exec $CONTAINER wp menu item add-custom "Primary Menu" '<%= item.title %>' '<%= item.url.startsWith('/') ? '${WP_URL}' + item.url : item.url %>' --allow-root

    <%_ }); _%>

    # Assign menu to location
    docker exec $CONTAINER wp menu location assign "Primary Menu" primary --allow-root

    log_info "Menu created"
}

# Configure security
configure_security() {
    log_info "Configuring security settings..."

    # Disable XML-RPC
    docker exec $CONTAINER wp config set XMLRPC_REQUEST false --raw --allow-root 2>/dev/null || true

    # Remove default posts/comments
    docker exec $CONTAINER wp post delete 1 --force --allow-root 2>/dev/null || true
    docker exec $CONTAINER wp post delete 2 --force --allow-root 2>/dev/null || true
    docker exec $CONTAINER wp comment delete 1 --force --allow-root 2>/dev/null || true

    # Delete unused themes
    docker exec $CONTAINER wp theme delete twentytwentythree --allow-root 2>/dev/null || true
    docker exec $CONTAINER wp theme delete twentytwentytwo --allow-root 2>/dev/null || true

    log_info "Security configured"
}

# Main execution
main() {
    log_info "Starting WordPress setup for <%= company.name %>..."

    wait_for_wordpress || {
        log_error "WordPress container not ready"
        exit 1
    }

    # Check if already installed
    if docker exec $CONTAINER wp core is-installed --allow-root 2>/dev/null; then
        log_info "WordPress already installed, skipping installation"
    else
        install_wordpress
    fi

    activate_theme
    activate_plugin
    install_plugins
    configure_settings
    create_pages
    set_homepage
    create_menu
    configure_security

    log_info "==========================================="
    log_info "<%= company.name %> WordPress setup complete!"
    log_info "==========================================="
    log_info "URL: $WP_URL"
    log_info "Admin: $WP_URL/wp-admin"
    log_info "Username: $WP_ADMIN_USER"
    log_info "Password: $WP_ADMIN_PASSWORD"
    log_info "==========================================="
}

main "$@"
