#!/bin/bash
#
# WPF - WordPress Site Factory CLI
# Rapidly create WordPress websites from development to production
#
# Version: 0.2.0-beta
#
# Usage: wpf [command]
#

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WPF_ROOT="$(dirname "$SCRIPT_DIR")"
CLI_DIR="$WPF_ROOT/cli"
LIB_DIR="$WPF_ROOT/lib"
PROJECTS_DIR="$WPF_ROOT/projects"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Source library files
source "$LIB_DIR/registry.sh"
source "$LIB_DIR/learnings.sh"

# Initialize registry
registry_init

# Print banner
print_banner() {
    echo -e "${CYAN}"
    echo "╔═══════════════════════════════════════════════════════════╗"
    echo "║     WPF - WordPress Site Factory                          ║"
    echo "║     Rapid WordPress Development to Production             ║"
    echo "║     v0.2.0-beta                                           ║"
    echo "╚═══════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# Print menu
print_menu() {
    # Show pending learnings count if any
    local learning_count=$(learnings_count 2>/dev/null || echo 0)
    local project_count=$(registry_count 2>/dev/null || echo 0)

    echo -e "${GREEN}What would you like to do?${NC}"
    echo -e "Projects: ${BLUE}$project_count${NC} | Pending Learnings: ${BLUE}$learning_count${NC}"
    echo ""
    echo "  1. Create new project"
    echo "  2. Continue existing project"
    echo "  3. List all projects"
    echo "  4. Register existing project"
    echo "  5. Deploy project"
    echo "  6. Run tests"
    echo "  7. Create backup"
    echo "  8. Health check (doctor)"
    echo "  9. Browse knowledge base"
    echo " 10. Capture learning"
    echo " 11. Review learnings"
    echo -e "${YELLOW}--- AI Orchestrator ---${NC}"
    echo " 12. Run AI research"
    echo " 13. Manage blueprints"
    echo " 14. Review blueprint"
    echo -e "${YELLOW}--- Phase 2: Design ---${NC}"
    echo " 15. Generate theme from blueprint"
    echo " 16. Generate HTML preview"
    echo " 17. Compare templates"
    echo " 18. List available presets"
    echo " 19. Help"
    echo "  0. Exit"
    echo ""
}

# Handle menu selection
handle_selection() {
    local choice=$1

    case $choice in
        1)
            echo ""
            read -p "Enter project name (e.g., acme-corp): " project_name
            if [ -n "$project_name" ]; then
                source "$CLI_DIR/create.sh" "$project_name"
            else
                echo -e "${RED}Project name is required${NC}"
            fi
            ;;
        2)
            echo ""
            echo "Registered projects:"
            registry_list simple 2>/dev/null | sed 's/^/  - /' || echo "  (none)"
            echo ""
            read -p "Enter project name to continue: " project_name
            if [ -n "$project_name" ]; then
                source "$CLI_DIR/continue.sh" "$project_name"
            else
                echo -e "${RED}Project name is required${NC}"
            fi
            ;;
        3)
            source "$CLI_DIR/list.sh"
            ;;
        4)
            echo ""
            read -p "Enter path to existing project: " project_path
            if [ -n "$project_path" ]; then
                source "$CLI_DIR/register.sh" "$project_path"
            else
                echo -e "${RED}Path is required${NC}"
            fi
            ;;
        5)
            echo ""
            echo "Deploy options:"
            echo "  1. Staging"
            echo "  2. Production"
            read -p "Select environment (1-2): " env_choice
            case $env_choice in
                1) source "$CLI_DIR/deploy.sh" staging ;;
                2) source "$CLI_DIR/deploy.sh" production ;;
                *) echo -e "${RED}Invalid option${NC}" ;;
            esac
            ;;
        6)
            source "$CLI_DIR/test.sh"
            ;;
        7)
            source "$CLI_DIR/backup.sh"
            ;;
        8)
            source "$CLI_DIR/doctor.sh"
            ;;
        9)
            source "$CLI_DIR/knowledge.sh"
            ;;
        10)
            source "$CLI_DIR/learn.sh"
            ;;
        11)
            source "$CLI_DIR/knowledge-review.sh"
            ;;
        12)
            # AI Research
            echo ""
            echo -e "${GREEN}AI Research - Choose research type:${NC}"
            echo "  1. Best Practices (industry website patterns)"
            echo "  2. Competitors (analyze competitor sites)"
            echo "  3. Full Research (both)"
            echo ""
            read -p "Select type (1-3): " research_type
            read -p "Enter industry (e.g., construction, restaurant): " industry

            ORCHESTRATOR_DIR="$WPF_ROOT/modules/orchestrator"
            case $research_type in
                1)
                    cd "$ORCHESTRATOR_DIR" && node src/cli/research.js best-practices --industry "$industry"
                    ;;
                2)
                    cd "$ORCHESTRATOR_DIR" && node src/cli/research.js competitors --industry "$industry"
                    ;;
                3)
                    cd "$ORCHESTRATOR_DIR" && node src/cli/research.js full --industry "$industry"
                    ;;
                *)
                    echo -e "${RED}Invalid option${NC}"
                    ;;
            esac
            ;;
        13)
            # Blueprint Management
            echo ""
            echo -e "${GREEN}Blueprint Management - Choose action:${NC}"
            echo "  1. Generate blueprint from intake"
            echo "  2. View existing blueprint"
            echo "  3. Export blueprint"
            echo ""
            read -p "Select action (1-3): " blueprint_action

            ORCHESTRATOR_DIR="$WPF_ROOT/modules/orchestrator"
            case $blueprint_action in
                1)
                    read -p "Enter intake JSON path: " intake_path
                    read -p "Enter research JSON path (optional, press Enter to skip): " research_path
                    if [ -n "$research_path" ]; then
                        cd "$ORCHESTRATOR_DIR" && node src/cli/blueprint.js generate "$intake_path" --research "$research_path"
                    else
                        cd "$ORCHESTRATOR_DIR" && node src/cli/blueprint.js generate "$intake_path"
                    fi
                    ;;
                2)
                    read -p "Enter blueprint JSON path: " blueprint_path
                    cd "$ORCHESTRATOR_DIR" && node src/cli/blueprint.js view "$blueprint_path"
                    ;;
                3)
                    read -p "Enter blueprint JSON path: " blueprint_path
                    read -p "Export format (md|json|html): " export_format
                    cd "$ORCHESTRATOR_DIR" && node src/cli/blueprint.js export "$blueprint_path" "$export_format"
                    ;;
                *)
                    echo -e "${RED}Invalid option${NC}"
                    ;;
            esac
            ;;
        14)
            # Blueprint Review
            echo ""
            echo -e "${GREEN}Blueprint Review - Choose action:${NC}"
            echo "  1. Run auto review"
            echo "  2. Start manual review"
            echo ""
            read -p "Select action (1-2): " review_action

            ORCHESTRATOR_DIR="$WPF_ROOT/modules/orchestrator"
            case $review_action in
                1)
                    read -p "Enter blueprint JSON path: " blueprint_path
                    cd "$ORCHESTRATOR_DIR" && node src/cli/review.js auto "$blueprint_path"
                    ;;
                2)
                    read -p "Enter blueprint JSON path: " blueprint_path
                    read -p "Reviewer name: " reviewer_name
                    cd "$ORCHESTRATOR_DIR" && node src/cli/review.js start "$blueprint_path" --operator "$reviewer_name"
                    ;;
                *)
                    echo -e "${RED}Invalid option${NC}"
                    ;;
            esac
            ;;
        15)
            # Phase 2: Generate Theme
            echo ""
            echo -e "${GREEN}Phase 2: Generate WordPress Theme${NC}"
            ORCHESTRATOR_DIR="$WPF_ROOT/modules/orchestrator"
            read -p "Enter blueprint JSON path [examples/blueprint-anywhere-solutions.json]: " blueprint_path
            blueprint_path=${blueprint_path:-examples/blueprint-anywhere-solutions.json}
            read -p "Output directory [output/theme]: " output_dir
            output_dir=${output_dir:-output/theme}
            cd "$ORCHESTRATOR_DIR" && node src/commands/design.js generate "$blueprint_path" --output "$output_dir"
            ;;
        16)
            # Phase 2: HTML Preview
            echo ""
            echo -e "${GREEN}Phase 2: Generate HTML Preview${NC}"
            ORCHESTRATOR_DIR="$WPF_ROOT/modules/orchestrator"
            read -p "Enter blueprint JSON path [examples/blueprint-anywhere-solutions.json]: " blueprint_path
            blueprint_path=${blueprint_path:-examples/blueprint-anywhere-solutions.json}
            read -p "Output directory [output/preview]: " output_dir
            output_dir=${output_dir:-output/preview}
            read -p "Fetch stock photos? (y/n) [n]: " stock_photos
            read -p "Show placeholder badges? (y/n) [n]: " show_badges

            extra_args=""
            [[ "$stock_photos" == "y" ]] && extra_args="$extra_args --stock-photos"
            [[ "$show_badges" == "y" ]] && extra_args="$extra_args --show-badges"

            cd "$ORCHESTRATOR_DIR" && node src/commands/design.js preview-html "$blueprint_path" --output "$output_dir" $extra_args
            ;;
        17)
            # Phase 2: Compare Templates
            echo ""
            echo -e "${GREEN}Phase 2: Compare Templates${NC}"
            ORCHESTRATOR_DIR="$WPF_ROOT/modules/orchestrator"
            read -p "Enter blueprint JSON path [examples/blueprint-anywhere-solutions.json]: " blueprint_path
            blueprint_path=${blueprint_path:-examples/blueprint-anywhere-solutions.json}
            cd "$ORCHESTRATOR_DIR" && node src/commands/design.js compare "$blueprint_path"
            ;;
        18)
            # Phase 2: List Presets
            echo ""
            echo -e "${GREEN}Phase 2: Available Template Presets${NC}"
            ORCHESTRATOR_DIR="$WPF_ROOT/modules/orchestrator"
            read -p "Filter by industry (press Enter for all): " industry
            if [ -n "$industry" ]; then
                cd "$ORCHESTRATOR_DIR" && node src/commands/design.js list-presets --industry "$industry"
            else
                cd "$ORCHESTRATOR_DIR" && node src/commands/design.js list-presets
            fi
            ;;
        19)
            echo ""
            echo -e "${GREEN}WPF - WordPress Site Factory v0.2.0-beta${NC}"
            echo ""
            echo "A CLI tool for rapidly creating WordPress websites."
            echo ""
            echo -e "${CYAN}Workflow:${NC}"
            echo "  1. Create new project - Interactive wizard to set up a new site"
            echo "  2. Continue project   - Resume work on an existing project"
            echo "  3. Develop            - Customize theme, add content"
            echo "  4. Test               - Run E2E and Lighthouse tests"
            echo "  5. Deploy             - Push to staging or production"
            echo ""
            echo -e "${CYAN}Knowledge System:${NC}"
            echo "  • Capture learnings - Record insights during development"
            echo "  • Review learnings  - See pending knowledge"
            echo "  • Knowledge base    - Browse all documentation"
            echo ""
            echo -e "${CYAN}Directories:${NC}"
            echo "  Projects:   $PROJECTS_DIR"
            echo "  Knowledge:  $WPF_ROOT/knowledge/"
            echo "  Learnings:  $WPF_ROOT/learnings/"
            echo "  Templates:  $WPF_ROOT/templates/"
            echo ""
            echo -e "${CYAN}Documentation:${NC}"
            echo "  README:     $WPF_ROOT/README.md"
            echo "  AI Guide:   $WPF_ROOT/CLAUDE.md"
            echo ""
            ;;
        0)
            echo ""
            echo -e "${GREEN}Goodbye!${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}Invalid option. Please select 0-19.${NC}"
            ;;
    esac
}

# Main interactive loop
main_interactive() {
    print_banner

    while true; do
        print_menu
        read -p "Select option (0-19): " choice
        handle_selection "$choice"

        if [ "$choice" != "0" ]; then
            echo ""
            read -p "Press Enter to continue..."
            clear
            print_banner
        fi
    done
}

# Main entry point
main() {
    # If command provided as argument, execute directly
    if [ $# -gt 0 ]; then
        COMMAND=$1
        shift

        case $COMMAND in
            create)
                if [ -z "$1" ]; then
                    read -p "Enter project name: " project_name
                    source "$CLI_DIR/create.sh" "$project_name"
                else
                    source "$CLI_DIR/create.sh" "$@"
                fi
                ;;
            continue)
                if [ -z "$1" ]; then
                    echo "Registered projects:"
                    registry_list simple 2>/dev/null | sed 's/^/  - /' || echo "  (none)"
                    read -p "Enter project name: " project_name
                    source "$CLI_DIR/continue.sh" "$project_name"
                else
                    source "$CLI_DIR/continue.sh" "$@"
                fi
                ;;
            list)
                source "$CLI_DIR/list.sh"
                ;;
            register)
                source "$CLI_DIR/register.sh" "$@"
                ;;
            unregister)
                source "$CLI_DIR/unregister.sh" "$@"
                ;;
            deploy)
                source "$CLI_DIR/deploy.sh" "$@"
                ;;
            test)
                source "$CLI_DIR/test.sh"
                ;;
            backup)
                source "$CLI_DIR/backup.sh"
                ;;
            doctor)
                source "$CLI_DIR/doctor.sh"
                ;;
            setup)
                source "$CLI_DIR/setup.sh" "$@"
                ;;
            status)
                source "$CLI_DIR/status.sh"
                ;;
            build)
                source "$CLI_DIR/build.sh" "$@"
                ;;
            optimize)
                source "$CLI_DIR/optimize.sh" "$@"
                ;;
            verify)
                source "$CLI_DIR/verify.sh" "$@"
                ;;
            discover)
                source "$CLI_DIR/discover.sh" "$@"
                ;;
            content)
                source "$CLI_DIR/content.sh" "$@"
                ;;
            auto)
                source "$CLI_DIR/auto.sh" "$@"
                ;;
            knowledge)
                if [ "$1" = "review" ]; then
                    shift
                    source "$CLI_DIR/knowledge-review.sh" "$@"
                elif [ "$1" = "merge" ]; then
                    shift
                    source "$CLI_DIR/knowledge-merge.sh" "$@"
                else
                    source "$CLI_DIR/knowledge.sh"
                fi
                ;;
            learn)
                source "$CLI_DIR/learn.sh" "$@"
                ;;
            research)
                # AI Orchestrator: Research command
                ORCHESTRATOR_DIR="$WPF_ROOT/modules/orchestrator"
                if [ ! -d "$ORCHESTRATOR_DIR" ]; then
                    echo -e "${RED}Error: Orchestrator module not found${NC}"
                    exit 1
                fi
                if [ -z "$1" ]; then
                    echo -e "${GREEN}WPF Research - AI-powered research for Discovery Phase${NC}"
                    echo ""
                    echo "Usage: wpf research <type> [options]"
                    echo ""
                    echo "Types:"
                    echo "  best-practices    Research industry best practices for website sections"
                    echo "  competitors       Research competitor websites"
                    echo "  full              Run both best-practices and competitor research"
                    echo ""
                    echo "Options:"
                    echo "  --industry <name>     Industry to research (e.g., construction, restaurant)"
                    echo "  --sections <list>     Comma-separated sections (hero,about,services,contact)"
                    echo "  --output <file>       Output file path (JSON)"
                    echo ""
                    echo "Examples:"
                    echo "  wpf research best-practices --industry construction"
                    echo "  wpf research competitors --industry \"precast concrete\""
                    echo "  wpf research full --industry restaurant --output ./research.json"
                else
                    cd "$ORCHESTRATOR_DIR" && node src/cli/research.js "$@"
                fi
                ;;
            blueprint)
                # AI Orchestrator: Blueprint command
                ORCHESTRATOR_DIR="$WPF_ROOT/modules/orchestrator"
                if [ ! -d "$ORCHESTRATOR_DIR" ]; then
                    echo -e "${RED}Error: Orchestrator module not found${NC}"
                    exit 1
                fi
                if [ -z "$1" ]; then
                    echo -e "${GREEN}WPF Blueprint - Generate and manage website blueprints${NC}"
                    echo ""
                    echo "Usage: wpf blueprint <command> [options]"
                    echo ""
                    echo "Commands:"
                    echo "  generate <intake>     Generate blueprint from client intake JSON"
                    echo "  view <file>           View an existing blueprint"
                    echo "  export <file> [fmt]   Export blueprint (md|json|html)"
                    echo ""
                    echo "Options:"
                    echo "  --research <file>     Include research JSON in generation"
                    echo "  --output <file>       Output file path"
                    echo ""
                    echo "Examples:"
                    echo "  wpf blueprint generate ./intake.json --research ./research.json"
                    echo "  wpf blueprint view ./blueprint.json"
                    echo "  wpf blueprint export ./blueprint.json md"
                else
                    cd "$ORCHESTRATOR_DIR" && node src/cli/blueprint.js "$@"
                fi
                ;;
            review)
                # AI Orchestrator: Review command
                ORCHESTRATOR_DIR="$WPF_ROOT/modules/orchestrator"
                if [ ! -d "$ORCHESTRATOR_DIR" ]; then
                    echo -e "${RED}Error: Orchestrator module not found${NC}"
                    exit 1
                fi
                if [ -z "$1" ]; then
                    echo -e "${GREEN}WPF Review - Operator quality review for blueprints${NC}"
                    echo ""
                    echo "Usage: wpf review <command> [options]"
                    echo ""
                    echo "Commands:"
                    echo "  auto <blueprint>        Run automated review checks"
                    echo "  start <blueprint>       Start interactive manual review"
                    echo "  status <review-file>    Show review status"
                    echo "  report <review-file>    Generate review report"
                    echo ""
                    echo "Options:"
                    echo "  --operator <name>       Reviewer name"
                    echo "  --output <dir>          Output directory"
                    echo ""
                    echo "Examples:"
                    echo "  wpf review auto ./blueprint-v1.json"
                    echo "  wpf review start ./blueprint-v1.json --operator \"John\""
                else
                    cd "$ORCHESTRATOR_DIR" && node src/cli/review.js "$@"
                fi
                ;;
            design)
                # Phase 2: Design command
                ORCHESTRATOR_DIR="$WPF_ROOT/modules/orchestrator"
                if [ ! -d "$ORCHESTRATOR_DIR" ]; then
                    echo -e "${RED}Error: Orchestrator module not found${NC}"
                    exit 1
                fi
                if [ -z "$1" ]; then
                    echo -e "${GREEN}WPF Design - Phase 2 theme generation${NC}"
                    echo ""
                    echo "Usage: wpf design <command> [options]"
                    echo ""
                    echo "Commands:"
                    echo "  generate <blueprint>         Generate WordPress theme from blueprint"
                    echo "  preview <blueprint>          Preview theme assembly (dry run)"
                    echo "  preview-html <blueprint>     Generate standalone HTML preview"
                    echo "  compare <blueprint>          Compare A/B/C template options"
                    echo "  tokens <blueprint>           Generate design tokens only"
                    echo "  list-presets                 List available template presets"
                    echo "  list-patterns <ind> <preset> List patterns in a preset"
                    echo ""
                    echo "Options:"
                    echo "  --output <dir>          Output directory"
                    echo "  --stock-photos          Fetch real images (preview-html)"
                    echo "  --show-badges           Show [SAMPLE] badges (preview-html)"
                    echo "  --industry <name>       Filter presets by industry"
                    echo ""
                    echo "Examples:"
                    echo "  wpf design generate ./blueprint.json --output ./output/theme"
                    echo "  wpf design preview-html ./blueprint.json --stock-photos"
                    echo "  wpf design compare ./blueprint.json"
                    echo "  wpf design list-presets --industry construction"
                else
                    cd "$ORCHESTRATOR_DIR" && node src/commands/design.js "$@"
                fi
                ;;
            help|-h|--help)
                print_banner
                echo -e "${GREEN}Usage:${NC} wpf [command] [options]"
                echo ""
                echo "Run 'wpf' without arguments for interactive menu."
                echo ""
                echo -e "${GREEN}Project Commands:${NC}"
                echo "  create <name>        Create a new WordPress project"
                echo "  continue <name>      Continue working on existing project"
                echo "  discover [opts]      Interactive discovery wizard for config"
                echo "                       Options: --quick, --json"
                echo "  list                 List all registered projects"
                echo "  register <path>      Register an existing project"
                echo "  unregister <name>    Remove project from registry"
                echo ""
                echo -e "${GREEN}Setup Commands:${NC}"
                echo "  setup                Zero-touch WordPress setup (install, theme, plugins, pages)"
                echo "  status               Show project completion status"
                echo ""
                echo -e "${GREEN}Development Commands:${NC}"
                echo "  build [target]       Build assets (css|images|critical|watch|all)"
                echo "  optimize [target]    Configure plugins (plugins|seo|cache|images|all)"
                echo "  content [cmd]        Generate content (prompts|pages|services|generate)"
                echo "  test [target]        Run tests (local|staging|production|URL)"
                echo "  deploy <env> [opts]  Deploy project (staging|production)"
                echo "                       Options: --build, --verify, --full, --dry-run"
                echo "  verify [target]      Verify deployment (smoke|files|performance|all)"
                echo "  backup               Create full backup"
                echo "  doctor               Health check for current project"
                echo ""
                echo -e "${GREEN}Automation:${NC}"
                echo "  auto [opts]          Full automation: discover → create → build → deploy"
                echo "                       Options: --quick, --skip-deploy, --skip-content"
                echo ""
                echo -e "${GREEN}Knowledge Commands:${NC}"
                echo "  knowledge            Browse knowledge base"
                echo "  knowledge review     Review pending learnings"
                echo "  knowledge merge      Merge learnings into knowledge base"
                echo "  learn [category]     Capture a new learning"
                echo ""
                echo -e "${GREEN}AI Orchestrator Commands:${NC}"
                echo "  research <type>      Run AI-powered research (best-practices|competitors|full)"
                echo "  blueprint <cmd>      Generate/manage blueprints (generate|view|export)"
                echo "  review <cmd>         Operator quality review (auto|start|status|report)"
                echo ""
                echo -e "${GREEN}Phase 2: Design Commands:${NC}"
                echo "  design <cmd>         Theme generation (generate|preview|preview-html|compare)"
                echo "                       generate: Full WordPress theme"
                echo "                       preview-html: Standalone HTML preview (fastest)"
                echo "                       compare: A/B/C template comparison"
                echo "                       list-presets: Available templates"
                echo ""
                echo -e "${GREEN}Other:${NC}"
                echo "  help                 Show this help message"
                echo "  version              Show version"
                echo ""
                ;;
            version|-v|--version)
                echo "WPF v0.2.0-beta"
                ;;
            *)
                echo -e "${RED}Unknown command: $COMMAND${NC}"
                echo "Run 'wpf help' for usage information."
                exit 1
                ;;
        esac
    else
        # No arguments - run interactive mode
        main_interactive
    fi
}

main "$@"
